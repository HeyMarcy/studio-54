/**
 * Gallery with Dynamic Cloudinary Images
 * =======================================
 * 
 * Images are loaded from images.json (generated by scripts/fetch-images.js)
 * 
 * To update images:
 * 1. Upload new images to Cloudinary 'studio-54' folder
 * 2. Run: node scripts/fetch-images.js
 * 3. Refresh the page
 */

// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
  // Cloudinary settings
  cloudName: 'dwfhcqaat',
  folder: 'studio-54',
  
  // Thumbnail settings - width-based for masonry columns
  thumbnail: {
    width: 800,
    quality: 'auto',
    format: 'auto',
    crop: 'scale'
  },
  
  // Full-size image settings (for lightbox) - height-based as requested
  fullSize: {
    height: 1160,
    quality: 'auto',
    format: 'auto',
    crop: 'scale'
  },
  
  // Animation settings
  fadeDelay: 80,
  fadeDuration: 500
};

// ============================================================================
// URL BUILDERS
// ============================================================================

/**
 * Build Cloudinary URL with transformations
 */
function cloudinaryUrl(publicId, options = {}) {
  const { width, height, quality, format, crop } = options;
  
  // Build dimension transform (width or height)
  const dimension = width ? `w_${width}` : `h_${height}`;
  const transforms = `${dimension},c_${crop},q_${quality},f_${format}`;
  
  return `https://res.cloudinary.com/${CONFIG.cloudName}/image/upload/${transforms}/${publicId}`;
}

/**
 * Get thumbnail URL for an image
 */
function getThumbnailUrl(image) {
  const publicId = image.publicId || `${CONFIG.folder}/${image.id}`;
  return cloudinaryUrl(publicId, CONFIG.thumbnail);
}

/**
 * Get full-size URL for lightbox
 */
function getFullUrl(image) {
  const publicId = image.publicId || `${CONFIG.folder}/${image.id}`;
  return cloudinaryUrl(publicId, CONFIG.fullSize);
}

// ============================================================================
// UTILITIES
// ============================================================================

/**
 * Clean caption text by removing first 4 and last 7 characters
 */
function cleanCaption(text) {
  if (!text || text.length <= 11) return text;
  return text.slice(4, -7);
}

// ============================================================================
// GALLERY RENDERER
// ============================================================================

/**
 * Create a single gallery item element
 */
function createGalleryItem(image, index) {
  const sizeClass = image.size === 'full' ? 'w-full' : 'w-full md:w-1/2';
  const caption = cleanCaption(image.alt);
  
  const item = document.createElement('div');
  item.className = `${sizeClass} p-1`;
  item.innerHTML = `
    <div class="overflow-hidden h-full w-full">
      <a href="${getFullUrl(image)}" data-fancybox="gallery" data-caption="${caption}">
        <img 
          src="${getThumbnailUrl(image)}"
          alt="${image.alt}"
          width="${image.width || 600}"
          height="${image.height || 400}"
          loading="${index < 4 ? 'eager' : 'lazy'}"
          decoding="async"
          class="gallery-image block h-full w-full object-cover object-center opacity-0 transition-all duration-500 transform hover:scale-110"
        />
      </a>
    </div>
  `;
  
  return item;
}

/**
 * Build masonry-style layout
 */
function buildMasonryLayout(images, container) {
  // Create two columns for desktop
  const leftColumn = document.createElement('div');
  leftColumn.className = 'flex w-full md:w-1/2 flex-wrap';
  
  const rightColumn = document.createElement('div');
  rightColumn.className = 'flex w-full md:w-1/2 flex-wrap';
  
  // Distribute images between columns
  images.forEach((image, index) => {
    const item = createGalleryItem(image, index);
    
    // Alternate between columns, or use custom logic
    if (index % 2 === 0) {
      leftColumn.appendChild(item);
    } else {
      rightColumn.appendChild(item);
    }
  });
  
  container.appendChild(leftColumn);
  container.appendChild(rightColumn);
}

/**
 * Build masonry layout using CSS columns
 */
function buildGridLayout(images, container) {
  // CSS columns create true masonry effect
  container.className = 'columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-4';
  
  images.forEach((image, index) => {
    const caption = cleanCaption(image.alt);
    const item = document.createElement('div');
    item.className = 'mb-4 break-inside-avoid';
    item.innerHTML = `
      <a href="${getFullUrl(image)}" data-fancybox="gallery" data-caption="${caption}" class="block overflow-hidden rounded-lg">
        <img 
          src="${getThumbnailUrl(image)}"
          alt="${image.alt}"
          width="${image.width || 600}"
          height="${image.height || 400}"
          loading="${index < 6 ? 'eager' : 'lazy'}"
          decoding="async"
          class="gallery-image w-full h-auto opacity-0 transition-all duration-500 transform hover:scale-105"
        />
      </a>
    `;
    container.appendChild(item);
  });
}

/**
 * Load images and build gallery
 */
async function loadGallery() {
  const gallery = document.getElementById('gallery');
  if (!gallery) return;
  
  // Show loading state
  gallery.innerHTML = '<p class="text-gray-500 p-4">Loading gallery...</p>';
  
  try {
    // Fetch images from JSON file
    const response = await fetch('dist/images.json');
    
    if (!response.ok) {
      throw new Error('Could not load images.json - run "node scripts/fetch-images.js" first');
    }
    
    const images = await response.json();
    
    if (images.length === 0) {
      gallery.innerHTML = '<p class="text-gray-500 p-4">No images found in gallery.</p>';
      return;
    }
    
    // Clear loading message
    gallery.innerHTML = '';
    
    // Choose layout style (uncomment preferred option)
    buildGridLayout(images, gallery);
    // buildMasonryLayout(images, gallery);
    
    // Initialize Fancybox
    if (typeof Fancybox !== 'undefined') {
      Fancybox.bind('[data-fancybox]', {
        Carousel: { infinite: true },
        Thumbs: { type: 'classic' },
        Images: { zoom: true }
      });
    }
    
    // Fade in images
    fadeInImages();
    
  } catch (error) {
    console.error('Gallery error:', error);
    gallery.innerHTML = `
      <div class="text-gray-500 p-4">
        <p>Unable to load gallery images.</p>
        <p class="text-sm mt-2">Run <code class="bg-gray-100 dark:bg-gray-800 px-1 rounded">node scripts/fetch-images.js</code> to generate the image list.</p>
      </div>
    `;
  }
}

// ============================================================================
// ANIMATIONS
// ============================================================================

/**
 * Fade in body when DOM is ready
 */
function fadeInBody() {
  document.body.classList.remove('opacity-0');
  document.body.classList.add('opacity-100');
}

/**
 * Staggered fade-in for gallery images
 */
function fadeInImages() {
  const images = document.querySelectorAll('.gallery-image');
  
  images.forEach((img, index) => {
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            setTimeout(() => {
              img.classList.remove('opacity-0');
              img.classList.add('opacity-100');
            }, index * CONFIG.fadeDelay);
            observer.unobserve(img);
          }
        });
      }, { threshold: 0.1 });
      
      observer.observe(img);
    } else {
      setTimeout(() => {
        img.classList.remove('opacity-0');
        img.classList.add('opacity-100');
      }, index * CONFIG.fadeDelay);
    }
  });
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  fadeInBody();
  loadGallery();
});